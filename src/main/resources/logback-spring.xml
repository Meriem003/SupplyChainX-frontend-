<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- Récupération de l'environnement depuis les propriétés Spring -->
    <springProperty scope="context" name="appName" source="spring.application.name" defaultValue="supplychain-management"/>
    <springProperty scope="context" name="environment" source="spring.profiles.active" defaultValue="dev"/>

    <!-- Appender Console (pour le développement local) -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>user_id</includeMdcKeyName>
            <includeMdcKeyName>user_role</includeMdcKeyName>
            <includeMdcKeyName>business_id</includeMdcKeyName>
            <includeMdcKeyName>endpoint</includeMdcKeyName>
            <includeMdcKeyName>http_status</includeMdcKeyName>
            <includeMdcKeyName>log_type</includeMdcKeyName>
            <customFields>{"application":"${appName}","environment":"${environment}"}</customFields>
        </encoder>
    </appender>

    <!-- Appender Fichier JSON (pour Elasticsearch via Filebeat ou lecture directe) -->
    <appender name="FILE_JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/application.json</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/application-%d{yyyy-MM-dd}.json</fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>user_id</includeMdcKeyName>
            <includeMdcKeyName>user_role</includeMdcKeyName>
            <includeMdcKeyName>business_id</includeMdcKeyName>
            <includeMdcKeyName>endpoint</includeMdcKeyName>
            <includeMdcKeyName>http_status</includeMdcKeyName>
            <includeMdcKeyName>log_type</includeMdcKeyName>
            <customFields>{"application":"${appName}","environment":"${environment}"}</customFields>
        </encoder>
    </appender>

    <!-- Appender Logstash TCP (envoi vers Logstash qui transmet à Elasticsearch) -->
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
        <destination>localhost:5000</destination>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>user_id</includeMdcKeyName>
            <includeMdcKeyName>user_email</includeMdcKeyName>
            <includeMdcKeyName>user_role</includeMdcKeyName>
            <includeMdcKeyName>business_id</includeMdcKeyName>
            <includeMdcKeyName>endpoint</includeMdcKeyName>
            <includeMdcKeyName>http_method</includeMdcKeyName>
            <includeMdcKeyName>http_status</includeMdcKeyName>
            <includeMdcKeyName>log_type</includeMdcKeyName>
            <includeMdcKeyName>action</includeMdcKeyName>
            <includeMdcKeyName>entity_type</includeMdcKeyName>
            <includeMdcKeyName>entity_id</includeMdcKeyName>
            <customFields>{"application":"${appName}","environment":"${environment}"}</customFields>
        </encoder>
        <!-- Ne pas bloquer l'application si Logstash/Elasticsearch est down -->
        <keepAliveDuration>5 minutes</keepAliveDuration>
        <reconnectionDelay>10 seconds</reconnectionDelay>
    </appender>

    <!-- Configuration des niveaux de log -->
    <logger name="com.supplychainx" level="INFO"/>
    <logger name="com.supplychainx.security" level="INFO"/>
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.springframework.security" level="INFO"/>
    <logger name="org.hibernate.SQL" level="DEBUG"/>

    <!-- Logger root - Active LOGSTASH pour Docker, CONSOLE + FILE_JSON pour dev local -->
    <springProfile name="docker">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE_JSON"/>
            <appender-ref ref="LOGSTASH"/>
        </root>
    </springProfile>
    
    <springProfile name="!docker">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE_JSON"/>
        </root>
    </springProfile>
</configuration>

